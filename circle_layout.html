<html>

<head>
<title>fractala</title>

<!--
TODO:
SOON...
* layer highlight is broken
* clear button
* all around better color handling
* better defaults mgmt/surfacing?
* layer list stuff to own file
* split out layer types (eventually)
* do proper accessors on stuff
* get jquery 3.3.1
* log channeling on watched values
* separate data func. from interface
* ID EVERYTHING! (working on it)
* styles to dedicated css
* color picker?
	- better placement, feedback?
* remove/delete layer
* configurable layer names
	-will users even care about layer names?
* way to highlight layer?
* clone layer?
* layer visibility?
* dismissable editor
* the stroke/color thing is getting confusing, sort out

LAYER UI STUFF
* expandable layer menu?
* currently editing layer
* layer visibility (control alpha probably)

MODAL NEEDS
* placement
* dismissal callback?

LESS SOON...
* multiple stages
	-define "stage"
	-stage renderer?
* svg features support
	- lines
	- layers
* window resize handling (is ok for now)

LATER...
*	layers?
* stage "component"
	-accordions?
	-re-arrangeable?
WAY LATER...
* animation
-->

<style>
body {
    width:100%;
    height:100%;
	 margin: 0px 0px 0px 0px;
	 position: relative;
	 font-family:sans-serif;
	 background-color:hsl(0,0%,93%)
    /* background-color:blue; */
}

.menuBarClass {
	position:fixed;
	float:right;
	right:0px;
	top:0px;
	border-width:0px 0px 2px 2px;
	border-color:black;
	border-style:solid;
	border-bottom-left-radius: 3px;
	background-color:lightgray;
	padding: 2px;
}

/* --- LAYER LIST --- */

/* .layerListContainer {
	position:fixed;
	float:left;
	left:0px;
	top:0px;
	border-width:0px 2px 2px 0px;
	border-color:black;
	border-style:solid;
	border-bottom-right-radius: 3px;
	background-color:lightgray;
	padding: 2px;
	min-width:10%;
}

.layerListContainer table {
	margin:2px;
	padding:10px 6px 6px 6px;
	border-collapse: collapse;
}

.layerList_Item {
	padding:0px 2px 0px 2px;
	margin:2px 0px 2px 0px;
}

.layerListItemName {
	margin:0px;
	border-radius:3px 0px 0px 3px;
	border-radius: 8px 0px 0px 8px;
}

.layerListActiveLayerIndicator {
	margin:0px;
	background-color:yellow;
}

tr.layerList_Item[data-active-layer=false] td.layerListActiveLayerIndicator {
	display:none;
}

tr.layerList_Item[data-active-layer=true] td.layerListActiveLayerIndicator {
	display:inline;
} */

/* ------- */

.menuBarClass button {
    display:block;
    border-radius: 3px;
}


.modal {
	width:50%;
	height:50%;
	color:white;
	background-color:rgb(0,0,0);
	position:fixed;
	left:0px;
	top:0px;
}

#colorPickId {
	background-color:black;
}

</style>

<script type="application/javascript" src="jquery-3.1.1.min.js"></script>
<script type="application/javascript" src="libs/utility.js"></script>
<script type="application/javascript" src="libs/fnc2d.js"></script>
<script type="application/javascript" src="libs/my2d.js"></script>
<script type="application/javascript" src="libs/myRangeInput.js"></script>
<script type="application/javascript" src="libs/WatchedValue.js"></script>
<script type="application/javascript" src="libs/modalize.js"></script>
<script type="application/javascript" src="libs/popupper.js"></script>
<script type="application/javascript" src="libs/LogChannels.js"></script>
<script type="application/javascript" src="svgee.js"></script>
<script type="application/javascript" src="fncColorPicker.js"></script>

<script type="application/javascript" src="Fractala.js"></script>
<script type="application/javascript" src="FractalaSVGRenderer.js"></script>

<!-- DATA -->
<!-- <script type="application/javascript" src="layers.js"></script> -->

 <!-- UI -->
 <link rel="stylesheet" type="text/css" href="ui/LayerMenu.css">
 <script type="application/javascript" src="ui/LayerMenu.js"></script>

<script type="application/javascript" src="ui/save_dialog.js"></script>

<!-- <link rel="stylesheet" type="text/css" href="ui/edit_layer_popup.css">
<script type="application/javascript" src="ui/edit_layer_popup.js"></script> -->

<script type="application/javascript">

// ----- EARLY INITS -----
LogChannels.CaptureConsoleLog();

// LogChannels.EnableChannel(popupper_channel_name, false);
LogChannels.EnableChannel(LayerMenu.log_channel, true);

// ----- GLOBALS -----
var main_log_channel = "main";

var fractala = null;
var fractala_svg_renderer = null;

var current_layer_name = "";

var view_width;
var view_height;

// var layer_manager = null;
var layer_menu = null;

var highlighted_layer = "";

// ---- COLOR ----
// var current_color = { hue:0, saturation:100, lightness:50 };
var color_picker = null;
var color_picker_dialog = null;

// ---- SAVE ----
var save_dialog = null;

var number_of_spokes = WatchedValue.Create(0, //default_number_of_spokes,
		[function(value) {	console.log("num spokes = " + value);
									getCurrentLayer().number_of_spokes = value;
									render();
								}]);

var spoke_length = WatchedValue.Create(0, //default_spoke_length,
		[function(value) {   console.log("spoke length = " + value);
									getCurrentLayer().spoke_length = value;
									render();
								}]);

var circle_radius = WatchedValue.Create(0,//default_circle_radius,
		[function(value) {   console.log("radius = " + value);
									getCurrentLayer().radius = value;
									render();
								}]);

var stroke_width = WatchedValue.Create(0,//default_stroke_width,
		[function(value) {	console.log("stroke width = " + value);
									getCurrentLayer().stroke_width = value;
									render();
									}]);

var spoke_rot_offset = WatchedValue.Create(0,//default_spoke_rot_offset,
		[function(value) {	console.log("spoke rot offset = " + value);
									getCurrentLayer().spoke_rot_offset = value;
									render();
									}]);

var current_color = WatchedValue.Create(	{hue:0, saturation:100, lightness:50},
		[function(value) {	console.log("current_color = " + JSON.stringify(value));
									$("#colorPickButtonId").css({"background-color":getColorString(value)});
									}]);
// --------------------------------------------------------
function syncRangeInputs()
{
	var current_layer = getCurrentLayer();

	$("#numSpokesId")[0].value = current_layer.number_of_spokes;
	$("#spokeLengthId")[0].value = current_layer.spoke_length;
	$("#spokeRotOffsetId")[0].value = current_layer.spoke_rot_offset;
	$("#circleRadiusId")[0].value = current_layer.radius;
	$("#strokeWidthId")[0].value = current_layer.stroke_width;
};

// ----------------------------------------------------------------------------
function setCurrentLayer(layer_name)
{
	var layer = fractala.getLayer(layer_name);

	$(`.layerList_Item`).attr("data-active-layer", false);

	current_layer_name = layer_name;
	console.log("setting layer to " + layer_name);

	$(`.layerList_Item[data-layer-name=${current_layer_name}]`).attr("data-active-layer", true);

	$("#colorPickButtonId").css("background-color",layer.stroke);

	syncRangeInputs();
}

// ----------------------------------------------------------------------------
function getCurrentLayer()
{
	return fractala.getLayer(current_layer_name);
}

// --------------------------------------------------------------------
function getNextName()
{
	var name = "c" + next_name_index;

	next_name_index += 1;

	return name;
}

// --------------------------------------------------------------------
function getNextStroke()
{
	var stroke = getColorString(current_color.get());

	return stroke;
}

// --------------------------------------------------------------------
// function renderLayerList()
// {
// 	fractala.layer_order.forEach( (current_layer_name) => {
// 		var current_layer = fractala.getLayer(current_layer_name);
// 		var $current_item = generateLayerListItem(current_layer_name, current_layer.stroke);

// 		$("#layerListId").prepend($list_item);
// 	});
// }

// --------------------------------------------------------------------
function generateLayerListItem(layer_name,background_color)
{
	var $layer_list_row_item = $(`<tr class="layerList_Item" ></tr>`);

	$layer_list_row_item.attr( {	"data-layer-name": layer_name,
										"id": `layerList_RowItem_${layer_name}_Id`,
										"data-active-layer": false,
										"data-layer-name": layer_name, } );


	var $name_td = $(`<td class="layerListItemName" id="layerListItemName_${layer_name}_Id">${layer_name}</td>`);
	// $name = $(`<div class="layerListItemName" id="layerListItemName_${layer_name}_Id">${layer_name}</div>`);
	$name_td.css({"background-color":background_color }); // ??
	// $name_td.append($name);

	var $active_td = $('<td class="layerListActiveLayerIndicator">_</td>');
	// var $active_indicator = $(`<div class="layerListActiveLayerIndicator">_</div>`);
	$active_td.attr("id", `layerListItemActiveIndicator_${layer_name}_Id` );
	// $active_td.append($active_indicator);
	// $active_td.click( asdf )

	$layer_list_row_item.append($name_td);
	$layer_list_row_item.append($active_td);

	$layer_list_row_item.mouseleave( (evt) => {
		highlightLayer("");
		// $layer_list_row_item.$popup_menu.dismiss();
	} );

	// TODO: send to more mature layer click handler
	$layer_list_row_item.click( (event) => 
	{ 
		console.log("clicked layer list item"); 
		setCurrentLayer(layer_name); 
	});

	return $layer_list_row_item;
}

// --------------------------------------------------------------------
function addLayer()
{
	var new_layer = fractala.addCirclesLayer({stroke:getColorString(current_color.get())});

	var $list_item = generateLayerListItem(new_layer.name, new_layer.stroke);
	
	$("#layerListId").prepend($list_item);

	// return next_name;
	return new_layer;
}

// --------------------------------------------------------------------
// returns: string "hsl(n,n%,n%)"
function getColorString(color)
{
	return `hsl(${color.hue},${color.saturation}%,${color.lightness}%)`;
}

// --------------------------------------------------------------------
// receives: hsl:{hue:number, saturation:number, lightness:number}
function setCurrentColor(hsl)
{
	// todo: fill out hsl? 
	current_color.set(hsl);
}

// --------------------------------------------------------------------
function highlightLayer(layer_name)
{
	console.log(`highlighting layer: "${layer_name}`);

	highlighted_layer = layer_name;

	if (layer_name.length == 0)
	{
		$(`#mySVG g`).attr("opacity", "1.0");
	}
	else
	{
		$("#mySVG g").each( function(index) 
		{ 
			var cur_layer = $(this).attr("data-layer-name")
			console.log(cur_layer);

			var cur_opacity = cur_layer === highlighted_layer ? 1.0 : 0.25;

			$(this).attr("opacity", cur_opacity);
		});
	}
}

var layers_menu_log_channel = "layersMenu";

// --------------------------------------------------------------------
function on_LayersMenuAddLayer(action)
{
	console.log(layers_menu_log_channel, "on_LayersMenuAddLayer()"); 

	var new_layer = fractala.addCirclesLayer({stroke:getColorString(current_color.get())});

	layer_menu.addLayer(new_layer.name);
	layer_menu.setEditingLayer(new_layer.name);

	return new_layer;
}

// --------------------------------------------------------------------
var layersMenu_actionMap = {
	"add_layer":on_LayersMenuAddLayer,
}

// --------------------------------------------------------------------
function onLayersMenuAction(action)
{
	console.log(layers_menu_log_channel, "layers menu action"); 
	console.log(layers_menu_log_channel, action);

	if (layersMenu_actionMap.hasOwnProperty(action.type))
	{
		var action_handler = layersMenu_actionMap[action.type];

		action_handler(action);
	}
	else
	{
		console.log(layers_menu_log_channel, `ERROR: action type ${action.type} not mapped to handler`);
	}
}

// --------------------------------------------------------------------
// --------------------------------------------------------------------
// --------------------------------------------------------------------
$(document).ready( function()
{
	// ---- DATA INIT ----
	fractala = new Fractala.Fractala();
	fractala_svg_renderer = new FractalaSVGRenderer.FractalaSVGRenderer(fractala, {width:view_width, height:view_width});

    // --- DUCTWORK ---
    // num circles
    let numSpokesRangeCallback = myRangeInput.createRange({id:'numSpokesId',
        containerId:'numSpokesRangeContainer',
        onInputHandler:number_of_spokes.set,
		  initialValue:0, //default_number_of_spokes,
		  wheelStep:1,
        min:1, max:100, step:1})

    number_of_spokes.addSetCallback(numSpokesRangeCallback);

    // spoke length
    let spokeLengthRangeCallback = myRangeInput.createRange({id:'spokeLengthId',
        containerId:'spokeLengthRangeContainer',
        onInputHandler:spoke_length.set,
		  initialValue:0, //default_spoke_length,
		  wheelStep:1,
        min:0, max:500, step:1})

    spoke_length.addSetCallback(spokeLengthRangeCallback);

    // spoke rot offset
    let spokeRotOffsetRangeCallback = myRangeInput.createRange({id:'spokeRotOffsetId',
        containerId:'spokeRotOffsetRangeContainer', 
        onInputHandler:spoke_rot_offset.set,
        initialValue:0, //default_spoke_rot_offset,
		  wheelStep:my2d.TWO_PI / 360,
        min:0, max:my2d.TWO_PI, step:0.01})

    spoke_rot_offset.addSetCallback(spokeRotOffsetRangeCallback);

    // circle radius
    let circleRadiusRangeCallback = myRangeInput.createRange({id:'circleRadiusId',
        containerId:'circleRadiusRangeContainer',
        onInputHandler:circle_radius.set,
        initialValue:0, //default_circle_radius,
		  wheelStep:1,
        min:5, max:500, step:1})

    circle_radius.addSetCallback(circleRadiusRangeCallback);

    // stroke width
    let strokeWidthRangeCallback = myRangeInput.createRange({id:'strokeWidthId',
        containerId:'strokeWidthRangeContainer',
        onInputHandler:stroke_width.set,
        initialValue:0, //default_stroke_width,
		  wheelStep:1,
        min:1, max:20, step:1})

	 stroke_width.addSetCallback(strokeWidthRangeCallback);
	 
	// --- UI INIT ---
	color_picker = new fncColorPicker.Create({color_picked_handler:onColorPicked, size:250, container_div_id:"colorpick", hue:current_color.hue, rot_offset:-Math.PI * 0.5});
	color_picker_dialog = new modalize.Create($("body"), color_picker.$container_div, "colorpick_cover", {left:50,top:20});
	save_dialog = new SaveDialog.Create();

	 // color the picker button with current color
	 // TODO: make function
	 $("#colorPickButtonId").css("background-color", getColorString(current_color.get()));

	// default the model
	// var default_layer = addLayer();
	// current_layer_name = default_layer.name;
	// setCurrentLayer(default_layer.name);

	// --- UI INIT ---
	layer_menu = new LayerMenu(fractala, onLayersMenuAction);
	layer_menu.generateMenu();
	$("body").append(layer_menu.$menu_content);

	var new_layer = on_LayersMenuAddLayer({});

	render();
});

// --------------------------------------------------------------------
function onBodyLoad()
{
    view_width = window.innerWidth;
    view_height = window.innerHeight;
};

/*
// --------------------------------------------------------------------
function onWheel()
{
};

// --------------------------------------------------------------------
function logStats()
{
   //  console.log( "viewbox width: " + $("#mySVG")[0].viewBox.baseVal.width );
   //  console.log( "viewbox height: " + $("#mySVG")[0].viewBox.baseVal.height );
}

// --------------------------------------------------------------------
function zoomIn()
{
    $("#mySVG")[0].viewBox.baseVal.width -= 10;
    $("#mySVG")[0].viewBox.baseVal.height -= 10;

    logStats();
}

// --------------------------------------------------------------------
function zoomOut()
{
    $("#mySVG")[0].viewBox.baseVal.width += 10;
    $("#mySVG")[0].viewBox.baseVal.height += 10;

    logStats();
}
*/

// --------------------------------------------------------------------
function show_svg() {
    var svg = document.getElementById("mySVG");
    var serializer = new XMLSerializer();
    var svg_blob = new Blob([serializer.serializeToString(svg)],
                            {'type': "image/svg+xml"});
    var object_url = URL.createObjectURL(svg_blob);

    // later... revokeObjectURL();
	 // var svg_win = window.open(url, "svg_win");
	 return object_url;
}

// --------------------------------------------------------------------
function render()
{
    $("#mySVG").remove();

   // var svg_elem = generate_svg();
	var svg_elem = fractala_svg_renderer.render();

    $("body").append(svg_elem);
}


// TODO: move upward
var svg_blob_url = null;

var svg_file_version = 1;

// ----------------------------------------------------------------------------
function onSave()
{
	// TODO: move to function?
	if (svg_blob_url)
	{
		window.URL.revokeObjectURL(svg_blob_url);
	}
	svg_blob_url = show_svg();

	save_dialog.start(svg_blob_url);
}

// ----------------------------------------------------------------------------
function onAddLayer()
{
	var new_layer = addLayer();
	setCurrentLayer(new_layer.name);
	render();
}

// ----------------------------------------------------------------------------
function onPickColor()
{
	color_picker_dialog.start();
}

// ----------------------------------------------------------------------------
function onColorPicked(color)
{
	color_picker_dialog.dismiss();

	current_color.set(color);

	if (current_layer_name !== "")
	{
		getCurrentLayer().stroke=getColorString(current_color.get());
		render();
	}

	// fix the layer list item background color
	var background_color_css = { "background-color":getColorString(current_color.get()) };
	$(`.layerList_Item[data-layer-name=${current_layer_name}] .layerListItemName`).css(background_color_css);

	$("#colorPickButtonId").css(background_color_css);
}

</script>

</head>

<!-- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --  -->
<body onload="onBodyLoad()">

<!-- <div id="layerListContainerId" class="layerListContainer">
	<button id="addLayerButtonId" onclick="onAddLayer()">+</button>
	<table id="layerListId"></table>
</div> -->


<div class="menuBarClass" id="menuBarId">
	<table>
		<tr><td id="numSpokesValueId">num</td><td id="numSpokesRangeContainer"></td></tr>
		<tr><td>length</td><td id="spokeLengthRangeContainer"></td></tr>
		<tr><td>rot</td><td id="spokeRotOffsetRangeContainer"></td></tr>
		<tr><td>radius</td><td id="circleRadiusRangeContainer"></td></tr>
		<tr><td>stroke</td><td id="strokeWidthRangeContainer"></td></tr>
	</table>
	 <button onclick="onSave()">save</button>
	 <button id="colorPickButtonId" onclick="onPickColor()">xxx</button>
</div>


<!-- <svg width="100%" height="100%" id="mySVG" viewbox="0 0 110 110"> -->
<!-- <g> -->
<!-- crosshairs -->
<!--
<line x1="-100" y1="0" x2="100" y2="0" style="stroke:rgb(0,0,0);stroke-width:2" />
<line x1="-0" y1="-100" x2="0" y2="100" style="stroke:rgb(0,0,0);stroke-width:2" />
-->

<!--
<line x1="10" y1="10" x2="100" y2="10" style="stroke:rgb(255,0,0);stroke-width:2" />
<line x1="100" y1="10" x2="100" y2="100" style="stroke:rgb(0,255,0);stroke-width:2" />
<line x1="100" y1="100" x2="10" y2="100" style="stroke:rgb(0,0,255);stroke-width:2" />
<line x1="10" y1="100" x2="10" y2="10" style="stroke:rgb(0,255,255);stroke-width:2" />
-->

<!-- </g> -->
<!-- </svg> -->

</body>

</html>