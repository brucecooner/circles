<html>

<head>
<title>circles</title>

<!--
TODO:
SOON...
* save business
	- cancellation
* styles to dedicated file
* color picker?
* remove layer
* configurable layer names
	-will users care about layer names?
* way to highlight layer?
* clone layer?
* layer visibility

LESS SOON...
* multiple stages
	-define "stage"
	-stage renderer?
* svg features support
	- lines
	- layers
* window resize handling (is ok for now)

LATER...
*	layers?
* stage "component"
	-accordions?
	-re-arrangeable?
WAY LATER...
* animation
-->

<style>
body {
    width:100%;
    height:100%;
    margin: 0px 0px 0px 0px;
    /* background-color:blue; */
}

.menuBarClass {
	position:fixed;
	float:right;
	right:0px;
	top:0px;
	border-width:0px 0px 2px 2px;
	border-color:black;
	border-style:solid;
	border-bottom-left-radius: 3px;
	background-color:lightgray;
	padding: 2px;
}

.layerListClass {
	position:fixed;
	float:left;
	left:0px;
	top:0px;
	border-width:0px 2px 2px 0px;
	border-color:black;
	border-style:solid;
	border-bottom-right-radius: 3px;
	background-color:lightgray;
	padding: 2px;
	min-width:10%;
}

.layerListClass ul {
	margin:2px;
	padding:15px;
}

.menuBarClass button {
    display:block;
    border-radius: 3px;
}

#addLayerButtonId {
	background-color:lightcoral;
	border-radius:7px;
	border-width:0px;
	margin:2px;
	/* padding:2px; */
	/* border-color:maroon; */
	/* border-style:solid;
	border-color:black;
	border-width:2px; */
}

#addLayerButtonId:hover {
	background-color:red;
}

#addLayerButtonId:hover::after {
	content:" add";
}

.modal {
	width:50%;
	height:50%;
	color:white;
	background-color:rgb(0,0,0);
	position:fixed;
	left:0px;
	top:0px;
}

#colorPickId {
	background-color:black;
}
</style>

<script type="application/javascript" src="jquery-3.1.1.min.js"></script>
<script type="application/javascript" src="libs/utility.js"></script>
<script type="application/javascript" src="libs/fnc2d.js"></script>
<script type="application/javascript" src="libs/my2d.js"></script>
<script type="application/javascript" src="libs/myRangeInput.js"></script>
<script type="application/javascript" src="libs/WatchedValue.js"></script>
<script type="application/javascript" src="modalize.js"></script>
<script type="application/javascript" src="svgee.js"></script>
<script type="application/javascript" src="fncColorPicker.js"></script>

<script type="application/javascript" src="layers.js"></script>
<script type="application/javascript" src="save_dialog.js"></script>


<script type="application/javascript">

// ----- GLOBALS -----
var view_width;
var view_height;

var x_translate = 0;
var y_translate = 0;

const default_number_of_spokes = 6;
const default_spoke_length = 100;
const default_spoke_rot_offset = 0;
const default_circle_radius = 50;
const default_stroke_width = 5;
const default_stroke = "rgb(255,0,0)";

var next_stroke = {r:100, g:0, b:0};
var stroke_step = {r:5, g:5, b:5 };
var next_name_index = 1;

var default_circle_layer_config = 
{
	stroke: default_stroke,
	radius: default_circle_radius,
	number_of_spokes: default_number_of_spokes,
	stroke_width: default_stroke_width,
	spoke_length: default_spoke_length,
	spoke_rot_offset: default_spoke_rot_offset,
};

var render_order = [];

var Layers = new LayersNS.Layers();

var highlighted_layer = "";

// var current_color = { hue:0, saturation:100, lightness:50 };
var color_picker = null;
var color_picker_dialog = null;

var number_of_spokes = WatchedValue.Create(default_number_of_spokes,
		[function(value) {	console.log("num spokes = " + value);
									getCurrentLayer().config.number_of_spokes = value;
									render();
								}]);

var spoke_length = WatchedValue.Create(default_spoke_length,
		[function(value) {   console.log("spoke length = " + value);
									getCurrentLayer().config.spoke_length = value;
									render();
								}]);

var circle_radius = WatchedValue.Create(default_circle_radius,
		[function(value) {   console.log("radius = " + value);
									getCurrentLayer().config.radius = value;
									render();
								}]);

var stroke_width = WatchedValue.Create(default_stroke_width,
		[function(value) {	console.log("stroke width = " + value);
									getCurrentLayer().config.stroke_width = value;
									render();
									}]);

var spoke_rot_offset = WatchedValue.Create(default_spoke_rot_offset,
		[function(value) {	console.log("spoke rot offset = " + value);
									getCurrentLayer().config.spoke_rot_offset = value;
									render();
									}]);

var current_color = WatchedValue.Create(	{hue:0, saturation:100, lightness:50},
		[function(value) {	console.log("current_color = " + JSON.stringify(value));
									$("#colorPickButtonId").css({"background-color":getColorString(value)});
									}]);
// --------------------------------------------------------
function syncRangeInputs(circle_layer_config)
{
	$("#numSpokesId")[0].value = circle_layer_config.number_of_spokes;
	$("#spokeLengthId")[0].value = circle_layer_config.spoke_length;
	$("#spokeRotOffsetId")[0].value = circle_layer_config.spoke_rot_offset;
	$("#circleRadiusId")[0].value = circle_layer_config.radius;
	$("#strokeWidthId")[0].value = circle_layer_config.stroke_width;
};

// ----------------------------------------------------------------------------
function setCurrentLayer(layer_name)
{
	console.log("setting layer to " + layer_name);

	Layers.setCurrentLayer(layer_name);

	syncRangeInputs(Layers.getCurrentLayer().config);
}

// ----------------------------------------------------------------------------
function getCurrentLayer()
{
	return Layers.getCurrentLayer();
}

// --------------------------------------------------------------------
function getNextName()
{
	var name = "c" + next_name_index;

	next_name_index += 1;

	return name;
}

// --------------------------------------------------------------------
function getNextStroke()
{
	var stroke = getColorString(current_color.get());

	return stroke;
}

// --------------------------------------------------------------------
function addLayer()
{
	var new_config = default_circle_layer_config;
	
	new_config.stroke = getNextStroke();
	var next_name = getNextName();

	Layers.addCircleLayer( next_name, new_config );
	render_order.push(next_name);

	var $list_item = $(`<li data-layer="${next_name}">${next_name}</li>`);
	$list_item.css({"background-color":new_config.stroke });
	$list_item.click( () => setCurrentLayer($list_item.attr("data-layer")) );
	$list_item.mouseover( (evt) =>
	{ 
		highlightLayer(next_name); 
	} );
	$list_item.mouseout( (evt) => {
		highlightLayer("");
	} );
	
	$("#layerListId #addLayerButtonId").before($list_item);

	return next_name;
}

// --------------------------------------------------------------------
// returns: string "hsl(n,n,n)"
function getColorString(color)
{
	return `hsl(${color.hue},${color.saturation}%,${color.lightness}%)`;
}

// --------------------------------------------------------------------
// receives: hsl:{hue:number, saturation:number, lightness:number}
function setCurrentColor(hsl)
{
	Object.assign(current_color, hsl);
}

// --------------------------------------------------------------------
function highlightLayer(layer_name)
{
	console.log(`highlighting layer: "${layer_name}`);

	highlighted_layer = layer_name;

	if (layer_name.length == 0)
	{
		$(`#mySVG g`).attr("opacity", "1.0");
	}
	else
	{
		// $("#mySVG g").each( (index) =>
		// {
		// 	console.log(index);
		// 	console.log(`processing layer: ${$(this).attr("data-layer-name")}`);
		// });
		$("#mySVG g").each( function(index) 
		{ 
			var cur_layer = $(this).attr("data-layer-name")
			console.log(cur_layer);

			var cur_opacity = cur_layer === highlighted_layer ? 1.0 : 0.25;

			$(this).attr("opacity", cur_opacity);
		});
		// render_order.forEach( (current_name) =>
		// {
		// 	var cur_opacity = (current_name == highlighted_layer) ? 1.0 : 0.5;

		// 	$(`#mySVG g[data-layer-name=${current_name}]`).attr("opacity", `"${cur_opacity}"`);
		// });
	}
}

// --------------------------------------------------------------------
// --------------------------------------------------------------------
// --------------------------------------------------------------------
$(document).ready( function()
{
	// ---- DATA INIT ----
	var new_layer_name = addLayer();

	Layers.setCurrentLayer(new_layer_name);

    // --- DUCTWORK ---
    // num circles
    let numSpokesRangeCallback = myRangeInput.createRange({id:'numSpokesId',
        containerId:'numSpokesRangeContainer',
        onInputHandler:number_of_spokes.set,
		  initialValue:default_number_of_spokes,
		  wheelStep:1,
        min:1, max:100, step:1})

    number_of_spokes.addSetCallback(numSpokesRangeCallback);

    // spoke length
    let spokeLengthRangeCallback = myRangeInput.createRange({id:'spokeLengthId',
        containerId:'spokeLengthRangeContainer',
        onInputHandler:spoke_length.set,
		  initialValue:default_spoke_length,
		  wheelStep:1,
        min:0, max:500, step:1})

    spoke_length.addSetCallback(spokeLengthRangeCallback);

    // spoke rot offset
    let spokeRotOffsetRangeCallback = myRangeInput.createRange({id:'spokeRotOffsetId',
        containerId:'spokeRotOffsetRangeContainer', 
        onInputHandler:spoke_rot_offset.set,
        initialValue:default_spoke_rot_offset,
		  wheelStep:my2d.TWO_PI / 360,
        min:0, max:my2d.TWO_PI, step:0.01})

    spoke_rot_offset.addSetCallback(spokeRotOffsetRangeCallback);

    // circle radius
    let circleRadiusRangeCallback = myRangeInput.createRange({id:'circleRadiusId',
        containerId:'circleRadiusRangeContainer',
        onInputHandler:circle_radius.set,
        initialValue:default_circle_radius,
		  wheelStep:1,
        min:5, max:500, step:1})

    circle_radius.addSetCallback(circleRadiusRangeCallback);

    // stroke width
    let strokeWidthRangeCallback = myRangeInput.createRange({id:'strokeWidthId',
        containerId:'strokeWidthRangeContainer',
        onInputHandler:stroke_width.set,
        initialValue:default_stroke_width,
		  wheelStep:1,
        min:1, max:20, step:1})

	 stroke_width.addSetCallback(strokeWidthRangeCallback);
	 
	 color_picker = new fncColorPicker.Create({color_picked_handler:onColorPicked, size:250, container_div_id:"colorpick", hue:current_color.hue, rot_offset:-Math.PI * 0.5});

	 color_picker_dialog = new modalize.Create($("body"), color_picker.$container_div, "colorpick_cover");

	 var color_string = getColorString(current_color);

	 // color the picker button with current color
	 $("#colorPickButtonId").css("background-color", getColorString(current_color.get()));

    render();
});

// --------------------------------------------------------------------
function onBodyLoad()
{
    view_width = window.innerWidth;
    view_height = window.innerHeight;
};

// --------------------------------------------------------------------
function onWheel()
{
};

// --------------------------------------------------------------------
function logStats()
{
   //  console.log( "viewbox width: " + $("#mySVG")[0].viewBox.baseVal.width );
   //  console.log( "viewbox height: " + $("#mySVG")[0].viewBox.baseVal.height );
}

// --------------------------------------------------------------------
function zoomIn()
{
    $("#mySVG")[0].viewBox.baseVal.width -= 10;
    $("#mySVG")[0].viewBox.baseVal.height -= 10;

    logStats();
}

// --------------------------------------------------------------------
function zoomOut()
{
    $("#mySVG")[0].viewBox.baseVal.width += 10;
    $("#mySVG")[0].viewBox.baseVal.height += 10;

    logStats();
}

// --------------------------------------------------------------------
function show_svg() {
    var svg = document.getElementById("mySVG");
    var serializer = new XMLSerializer();
    var svg_blob = new Blob([serializer.serializeToString(svg)],
                            {'type': "image/svg+xml"});
    var object_url = URL.createObjectURL(svg_blob);

	// $("#menuBarId").append( $(`<a href=${url} download="test_svg.svg">linky</a>`));

    // later... revokeObjectURL();
	 // var svg_win = window.open(url, "svg_win");
	 return object_url;
}

// --------------------------------------------------------------------
function generate_layer(circle_layer)
{
	var current_config = circle_layer.config;

	const degrees_per_radian = 360.0 / my2d.TWO_PI;
	var rotate_degrees = current_config.spoke_rot_offset * degrees_per_radian;
	var transform_attribute = `transform="rotate(${rotate_degrees})"`;

	var svg_elem = `<g data-layer-name="${circle_layer.name}" ${transform_attribute}>`;

	var current_center = new fnc2d.Point(0, -current_config.spoke_length);

	var rotation = my2d.TWO_PI / current_config.number_of_spokes;

	for (var current_spoke = 0; current_spoke < current_config.number_of_spokes; current_spoke += 1)
	{
		var current_circle = svgee.circle(	current_center.x, current_center.y, 
															current_config.radius,
															{ stroke_width:current_config.stroke_width, stroke:current_config.stroke });

		svg_elem += current_circle;

		current_center = current_center.rotate(rotation);
	}

	svg_elem += "</g>";
	
	return svg_elem;
}

// --------------------------------------------------------------------
function generate_svg()
{
    var width = view_width;
    var height = view_height;
    var x = -view_width / 2;
    var y = -view_height / 2;

	 var svg_elem = `<svg width="100%" height="100%" id="mySVG" viewbox="${x} ${y} ${width} ${height}">`;

	render_order.forEach( (current_name) =>
	{
		svg_elem += generate_layer(Layers.getLayer(current_name));
	});

	svg_elem += "</svg>";

	return svg_elem;
};

// --------------------------------------------------------------------
function render()
{
    $("#mySVG").remove();

    var svg_elem = generate_svg();

    $("body").append(svg_elem);
}

// TODO: move upward
var save_modal = null;
var svg_blob_url = null;

var svg_file_version = 1;

// ----------------------------------------------------------------------------
function onSave()
{
	// TODO: move to function?
	if (svg_blob_url)
	{
		window.URL.revokeObjectURL(svg_blob_url);
	}
	svg_blob_url = show_svg();

	save_modal = openSaveDialog(svg_blob_url);
}

// ----------------------------------------------------------------------------
function onAddLayer()
{
	addLayer();
	render();

	console.log(render_order);
}

// ----------------------------------------------------------------------------
function onPickColor()
{
	//asdf

	color_picker_dialog.start();
}

// ----------------------------------------------------------------------------
function onColorPicked(color)
{
	color_picker_dialog.dismiss();

	current_color.set(color);
}

</script>

</head>

<!-- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --  -->
<body onload="onBodyLoad()">

<div class="layerListClass">
	<ul id="layerListId">		
		<button id="addLayerButtonId" onclick="onAddLayer()">+</button>
	</ul>
</div>
<div class="menuBarClass" id="menuBarId">
	<table>
		<tr><td id="numSpokesValueId">num</td><td id="numSpokesRangeContainer"></td></tr>
		<tr><td>length</td><td id="spokeLengthRangeContainer"></td></tr>
		<tr><td>rot</td><td id="spokeRotOffsetRangeContainer"></td></tr>
		<tr><td>radius</td><td id="circleRadiusRangeContainer"></td></tr>
		<tr><td>stroke</td><td id="strokeWidthRangeContainer"></td></tr>
	</table>
	 <button onclick="onSave()">save</button>
	 <button id="colorPickButtonId" onclick="onPickColor()">xxx</button>
</div>


<!-- <svg width="100%" height="100%" id="mySVG" viewbox="0 0 110 110"> -->
<!-- <g> -->
<!-- crosshairs -->
<!--
<line x1="-100" y1="0" x2="100" y2="0" style="stroke:rgb(0,0,0);stroke-width:2" />
<line x1="-0" y1="-100" x2="0" y2="100" style="stroke:rgb(0,0,0);stroke-width:2" />
-->

<!--
<line x1="10" y1="10" x2="100" y2="10" style="stroke:rgb(255,0,0);stroke-width:2" />
<line x1="100" y1="10" x2="100" y2="100" style="stroke:rgb(0,255,0);stroke-width:2" />
<line x1="100" y1="100" x2="10" y2="100" style="stroke:rgb(0,0,255);stroke-width:2" />
<line x1="10" y1="100" x2="10" y2="10" style="stroke:rgb(0,255,255);stroke-width:2" />
-->

<!-- </g> -->
<!-- </svg> -->

</body>

</html>